{% extends "base.html" %}

{% block title %}Dashboard - Overmap{% endblock %}

{% block content %}
<h3 class="mb-4">Hola, {{ user.username }}</h3>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-bar-chart-fill"></i> Totales</h5>
                <p class="display-6">{{ workflows_total }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-hourglass-split"></i> En Proceso</h5>
                <p class="display-6">{{ workflows_processing }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-check-circle-fill"></i> Completados</h5>
                <p class="display-6">{{ workflows_completed }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-x-circle-fill"></i> Fallidos</h5>
                <p class="display-6">{{ workflows_failed }}</p>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-plus-circle"></i> Crear Nuevo Workflow</h5>
                
                <form method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                    <label for="workflowName" class="form-label">Nombre del Reporte</label>
                    <input type="text" class="form-control" id="workflowName" name="workflow_name" required>
                    </div>
                    <div class="mb-3">
                    <label for="queryNL" class="form-label">¿Qué deseas buscar?</label>
                    <textarea class="form-control" id="queryNL" rows="3" name="query_nl" placeholder="Ej: Restaurantes en Palermo, Buenos Aires" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Iniciar</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-list-task"></i> Mis Workflows</h5>
                
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Estado</th>
                        <th>Creado</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for workflow in workflows %}
                    <tr>
                        <td>{{ workflow.name }}</td>
                        <td>
                        {% if workflow.status == 'COMPLETED' %}
                            <span class="badge bg-success">{{ workflow.get_status_display }}</span>
                        {% elif workflow.status == 'PENDING' %}
                            <span class="badge bg-secondary">{{ workflow.get_status_display }}</span>
                        {% elif workflow.status == 'RUNNING' %}
                            <span class="badge bg-primary">{{ workflow.get_status_display }}</span>
                        {% elif workflow.status == 'FAILED' %}
                            <span class="badge bg-danger" title="{{ workflow.error_message|default:'Error desconocido' }}">{{ workflow.get_status_display }}</span>
                        {% elif workflow.status == 'EXPORTED' %}
                            <span class="badge bg-info">{{ workflow.get_status_display }}</span>
                        {% endif %}
                        </td>
                        <td>{{ workflow.created_at|date:"d/m/Y H:i" }}</td>
                        <td class="text-end">
                        
                        {% if workflow.status == 'COMPLETED' %}
                            <form action="{% url 'export_start' workflow.pk %}" method="POST" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-warning">
                                <i class="bi bi-box-arrow-up-right"></i> Exportar
                            </button>
                            </form>
                        
                        {% elif workflow.status == 'EXPORTED' %}
                            <a href="{% url 'workflow-export-download' workflow.pk %}" class="btn btn-sm btn-success">
                                <i class="bi bi-download"></i> Descargar
                            </a>
                        
                        {% elif workflow.status == 'FAILED' %}
                            <a href="#" class="btn btn-sm btn-outline-danger disabled">Falló</a>
                            
                        {% else %}
                            <span class="text-muted fst-italic">Procesando...</span>
                        {% endif %}
                        
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No has creado ningún workflow todavía.</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}